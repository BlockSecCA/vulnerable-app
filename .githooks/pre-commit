#!/bin/bash
# Generic pre-commit hook for dev repos
# Validates Python, shell, and checks for secrets

set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

echo "Running pre-commit checks..."

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No staged files to check${NC}"
    exit 0
fi

FAILED=0

# Python syntax check
PY_FILES=$(echo "$STAGED_FILES" | grep '\.py$' || true)
if [ -n "$PY_FILES" ]; then
    echo -n "Checking Python syntax... "
    PY_FAILED=0
    for file in $PY_FILES; do
        if ! python3 -m py_compile "$REPO_ROOT/$file" 2>/dev/null; then
            echo -e "${RED}FAILED${NC}: $file"
            python3 -m py_compile "$REPO_ROOT/$file"
            PY_FAILED=1
        fi
    done
    if [ $PY_FAILED -eq 0 ]; then
        echo -e "${GREEN}OK${NC}"
    else
        FAILED=1
    fi
fi

# Shell syntax check
SH_FILES=$(echo "$STAGED_FILES" | grep '\.sh$' || true)
if [ -n "$SH_FILES" ]; then
    echo -n "Checking shell syntax... "
    SH_FAILED=0
    for file in $SH_FILES; do
        if ! bash -n "$REPO_ROOT/$file" 2>/dev/null; then
            echo -e "${RED}FAILED${NC}: $file"
            bash -n "$REPO_ROOT/$file"
            SH_FAILED=1
        fi
    done
    if [ $SH_FAILED -eq 0 ]; then
        echo -e "${GREEN}OK${NC}"
    else
        FAILED=1
    fi
fi

# Secrets check
echo -n "Checking for secrets patterns... "
SECRET_PATTERNS=(
    'AKIA[0-9A-Z]{16}'
    'ghp_[a-zA-Z0-9]{36}'
    'sk-[a-zA-Z0-9]{48}'
    'xox[baprs]-[0-9a-zA-Z-]+'
    'BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY'
)

SECRETS_FOUND=0
for file in $STAGED_FILES; do
    if [[ "$file" == *.png ]] || [[ "$file" == *.jpg ]]; then
        continue
    fi
    for pattern in "${SECRET_PATTERNS[@]}"; do
        if git show ":$file" 2>/dev/null | grep -qE "$pattern"; then
            if [ $SECRETS_FOUND -eq 0 ]; then
                echo -e "${RED}FAILED${NC}"
            fi
            echo -e "  ${RED}Potential secret in $file${NC}"
            SECRETS_FOUND=1
        fi
    done
done

if [ $SECRETS_FOUND -eq 0 ]; then
    echo -e "${GREEN}OK${NC}"
else
    FAILED=1
fi

echo ""
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}Pre-commit checks failed.${NC}"
    exit 1
else
    echo -e "${GREEN}All checks passed.${NC}"
    exit 0
fi
